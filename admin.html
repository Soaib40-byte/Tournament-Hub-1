<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tournament Admin - Pro Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #2563eb; --secondary: #0f172a; --success: #16a34a; --danger: #dc2626; --bg: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg); padding-bottom: 80px; }
        header { background: var(--secondary); color: white; padding: 15px; text-align: center; font-size: 18px; font-weight: bold; position: sticky; top: 0; z-index: 100; }
        .container { padding: 15px; max-width: 600px; margin: auto; }
        .section { display: none; }
        .section.active { display: block; }
        .card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        .card h3 { margin: 0 0 10px 0; font-size: 16px; color: var(--secondary); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; box-sizing: border-box; background: #fff; }
        .btn { width: 100%; padding: 10px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; transition: 0.3s; margin: 5px 0; }
        .btn-add { background: var(--primary); }
        .btn-approve { background: var(--success); }
        .btn-reject { background: var(--danger); }
        .btn-delete { background: #64748b; font-size: 12px; }

        .filter-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { flex: 1; padding: 10px; border: none; border-radius: 8px; background: #e2e8f0; color: #475569; font-weight: bold; cursor: pointer; font-size: 12px; white-space: nowrap; }
        .filter-btn.active { background: var(--primary); color: white; }

        .flex-btns { display: flex; gap: 8px; }
        .status { font-size: 11px; padding: 3px 8px; border-radius: 20px; text-transform: uppercase; font-weight: bold; }
        .pending { background: #fef9c3; color: #854d0e; }
        .approved { background: #dcfce7; color: #166534; }
        .rejected { background: #fee2e2; color: #991b1b; }

        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: white; display: flex; border-top: 1px solid #e2e8f0; height: 65px; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #64748b; font-size: 10px; cursor: pointer; }
        .nav-item i { font-size: 18px; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }

        .player-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #f1f5f9; }
        .player-item:last-child { border-bottom: none; }
        .player-name { font-weight: 600; color: #334155; }
    </style>
</head>
<body>

<header>Admin Control Panel</header>

<div class="container">
    <div id="match-sec" class="section active">
        <div class="card">
            <h3>Create Match</h3>
            <select id="mGame">
                <option value="Free Fire">Free Fire</option>
                <option value="Blood Strike">Blood Strike</option>
            </select>
            <input id="mTitle" placeholder="Match Title">
            <select id="mMode">
                <option value="Solo">Solo</option>
                <option value="Duo">Duo</option>
                <option value="Squad">Squad</option>
            </select>
            <input id="mEntry" type="number" placeholder="Entry Fee">
            <input id="mPrize" type="number" placeholder="Total Prize">
            <input id="mLimit" type="number" placeholder="Join Limit (e.g. 48)">
            <label style="font-size: 12px; color: #64748b; margin-left: 5px;">Select Match Time:</label>
            <input id="mTime" type="datetime-local">
            <button class="btn btn-add" onclick="addMatch()">Publish Match</button>
        </div>
        <div id="matchList"></div>
    </div>

    <div id="win-sec" class="section">
        <div class="filter-tabs">
            <button id="tab-p-list" class="filter-btn active" onclick="switchWinTab('player-list')">Player List</button>
            <button id="tab-w-list" class="filter-btn" onclick="switchWinTab('winner-list')">Winner List</button>
        </div>

        <div id="player-list-area">
            <div class="card">
                <h3>Select Match to See Players</h3>
                <select id="matchSelect" onchange="loadPlayersForMatch(this.value)">
                    <option value="">Select Match</option>
                </select>
            </div>
            <div id="joinedPlayers" class="card" style="padding:0;">
                <p style="padding:20px; text-align:center; color:#94a3b8;">Select a match to load players</p>
            </div>
        </div>

        <div id="winner-list-area" style="display:none">
            <div id="winnerList"></div>
        </div>
    </div>

    <div id="dep-sec" class="section">
        <h2 style="font-size: 18px;">Deposit Requests</h2>
        <div class="filter-tabs">
            <button class="filter-btn active" onclick="filterDep('pending', this)">Pending</button>
            <button class="filter-btn" onclick="filterDep('approved', this)">Approved</button>
            <button class="filter-btn" onclick="filterDep('rejected', this)">Rejected</button>
        </div>
        <div id="depositList"></div>
    </div>

    <div id="with-sec" class="section">
        <h2 style="font-size: 18px;">Withdraw Requests</h2>
        <div class="filter-tabs">
            <button class="filter-btn active" onclick="filterWith('pending', this)">Pending</button>
            <button class="filter-btn" onclick="filterWith('approved', this)">Approved</button>
            <button class="filter-btn" onclick="filterWith('rejected', this)">Rejected</button>
        </div>
        <div id="withdrawList"></div>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="switchTab('match-sec', this)"><i class="fas fa-trophy"></i>Matches</div>
    <div class="nav-item" onclick="switchTab('win-sec', this)"><i class="fas fa-crown"></i>Winners</div>
    <div class="nav-item" onclick="switchTab('dep-sec', this)"><i class="fas fa-wallet"></i>Deposit</div>
    <div class="nav-item" onclick="switchTab('with-sec', this)"><i class="fas fa-money-bill-wave"></i>Withdraw</div>
</nav>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDgBrES-3lWjeFVo6vz3jfMOyCl_tgy_RQ",
        authDomain: "tournament-hub-a936a.firebaseapp.com",
        databaseURL: "https://tournament-hub-a936a-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "tournament-hub-a936a",
        storageBucket: "tournament-hub-a936a.appspot.com",
        messagingSenderId: "968072956918",
        appId: "1:968072956918:web:fee6b8c7cfdf1f77c115d7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function switchTab(id, el) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        el.classList.add('active');
        if(id === 'win-sec') { updateMatchDropdown(); loadWinners(); }
    }

    function switchWinTab(tab) {
        document.getElementById('tab-p-list').classList.toggle('active', tab === 'player-list');
        document.getElementById('tab-w-list').classList.toggle('active', tab === 'winner-list');
        document.getElementById('player-list-area').style.display = (tab === 'player-list') ? 'block' : 'none';
        document.getElementById('winner-list-area').style.display = (tab === 'winner-list') ? 'block' : 'none';
    }

    // --- Winner Management ---
    function updateMatchDropdown() {
        const select = document.getElementById('matchSelect');
        db.ref('matches').once('value', snap => {
            select.innerHTML = '<option value="">Select Match</option>';
            snap.forEach(child => {
                const m = child.val();
                select.innerHTML += `<option value="${child.key}">${m.title}</option>`;
            });
        });
    }

    function loadPlayersForMatch(matchId) {
        const list = document.getElementById('joinedPlayers');
        if(!matchId) { list.innerHTML = '<p style="padding:20px; text-align:center; color:#94a3b8;">Select a match</p>'; return; }

        db.ref('matchPlayers/' + matchId).on('value', snap => {
            list.innerHTML = '';
            if(!snap.exists()) { list.innerHTML = '<p style="padding:20px; text-align:center;">No players</p>'; return; }
            snap.forEach(child => {
                const p = child.val();
                list.innerHTML += `<div class="player-item">
                    <span class="player-name">${p.gameName}</span>
                    <button class="btn btn-add" style="width:auto; padding:5px 12px;" onclick="addAsWinner('${matchId}', '${child.key}', '${p.gameName}')">Win</button>
                </div>`;
            });
        });
    }

    function addAsWinner(mId, uId, name) {
        const prize = prompt(`Enter Prize for ${name}:`);
        if(prize && !isNaN(prize)) {
            db.ref('winners').push({ matchId: mId, userId: uId, userName: name, prize: Number(prize), time: Date.now() });
            db.ref('users/' + uId + '/balance').transaction(c => (c || 0) + Number(prize));
            alert("Winner Set!");
        }
    }

    function loadWinners() {
        db.ref('winners').on('value', snap => {
            const list = document.getElementById('winnerList');
            list.innerHTML = '<h3>History</h3>';
            snap.forEach(child => {
                const w = child.val();
                list.innerHTML += `<div class="card" style="display:flex; justify-content:space-between;">
                    <span><b>${w.userName}</b></span><span style="color:green">+৳${w.prize}</span>
                </div>`;
            });
        });
    }

    // --- Match Control ---
    function addMatch() {
        const title = document.getElementById('mTitle').value;
        const timeInput = document.getElementById('mTime').value;
        const game = document.getElementById('mGame').value;

        if(!title || !timeInput) return alert("Title/Time missing");

        // সময়কে সঠিক কাউন্টডাউনের জন্য Timestamp (মিলিসেকেন্ড) এ রূপান্তর করা হয়েছে
        const timestamp = new Date(timeInput).getTime();

        db.ref('matches').push({
            title: title,
            game: game,
            type: document.getElementById('mMode').value,
            entryFee: Number(document.getElementById('mEntry').value),
            prize: Number(document.getElementById('mPrize').value),
            limit: Number(document.getElementById('mLimit').value) || 48,
            time: timestamp, // এখানে এখন টাইমস্ট্যাম্প সেভ হবে
            roomId: "Waiting...",
            roomPass: "Waiting...",
            status: 'upcoming'
        }).then(() => {
            alert("Match Published!");
            // ইনপুট বক্স খালি করা
            document.getElementById('mTitle').value = "";
            document.getElementById('mEntry').value = "";
            document.getElementById('mPrize').value = "";
            document.getElementById('mTime').value = "";
        }).catch(err => alert("Error: " + err.message));
    }

    db.ref('matches').on('value', snap => {
        const list = document.getElementById('matchList');
        list.innerHTML = '';
        snap.forEach(child => {
            const m = child.val();
            list.innerHTML += `<div class="card">
                <h3>${m.title} (${m.game})</h3>
                <div class="flex-btns">
                    <input id="ri-${child.key}" value="${m.roomId}" placeholder="Room ID">
                    <input id="rp-${child.key}" value="${m.roomPass}" placeholder="Password">
                </div>
                <button class="btn btn-add" onclick="updateRoom('${child.key}')">Update Room</button>
                <button class="btn btn-delete" onclick="deleteMatch('${child.key}')">Delete</button>
            </div>`;
        });
    });

    // --- Deposit ---
    let currentDepFilter = 'pending';
    function filterDep(status, el) {
        currentDepFilter = status;
        document.querySelectorAll('#dep-sec .filter-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        loadDeposits();
    }

    function loadDeposits() {
        db.ref('depositRequests').on('value', snap => {
            const list = document.getElementById('depositList');
            list.innerHTML = '';
            snap.forEach(child => {
                const d = child.val();
                if(d.status === currentDepFilter) {
                    list.innerHTML += `<div class="card">
                        <b>ID: ${d.userId.slice(-6)}</b> | ৳${d.amount} <span class="status ${d.status}">${d.status}</span><br>
                        TID: ${d.transactionId}
                        ${d.status === 'pending' ? `<div class="flex-btns">
                            <button class="btn btn-approve" onclick="approveDep('${child.key}','${d.userId}',${d.amount})">Approve</button>
                            <button class="btn btn-reject" onclick="updateStatus('depositRequests','${child.key}','rejected')">Reject</button>
                        </div>` : ''}
                    </div>`;
                }
            });
        });
    }

    // --- Withdraw ---
    let currentWithFilter = 'pending';
    function filterWith(status, el) {
        currentWithFilter = status;
        document.querySelectorAll('#with-sec .filter-btn').forEach(b => b.classList.remove('active'));
        el.classList.add('active');
        loadWithdrawals();
    }

    function loadWithdrawals() {
        db.ref('withdrawRequests').on('value', snap => {
            const list = document.getElementById('withdrawList');
            list.innerHTML = '';
            snap.forEach(child => {
                const w = child.val();
                if(w.status === currentWithFilter) {
                    list.innerHTML += `<div class="card">
                        <b>ID: ${w.userId.slice(-6)}</b> | ৳${w.amount} <span class="status ${w.status}">${w.status}</span><br>
                        No: ${w.accountNumber}
                        ${w.status === 'pending' ? `<div class="flex-btns">
                            <button class="btn btn-approve" onclick="updateStatus('withdrawRequests','${child.key}','approved')">Approve</button>
                            <button class="btn btn-reject" onclick="rejectWithdraw('${child.key}','${w.userId}',${w.amount})">Reject</button>
                        </div>` : ''}
                    </div>`;
                }
            });
        });
    }

    // --- Utils & Bug Fixes ---
    function approveDep(id, uid, amt) {
        db.ref('depositRequests/'+id).update({status:'approved'});
        db.ref('users/'+uid+'/balance').transaction(b => (b||0) + Number(amt));
        alert("Deposit Approved!");
    }

    function rejectWithdraw(id, uid, amt) {
        db.ref('withdrawRequests/'+id).update({status:'rejected'});
        db.ref('users/'+uid+'/balance').transaction(b => (b||0) + Number(amt));
        alert("Withdraw Rejected & Refunded!");
    }

    function updateStatus(path, id, status) { 
        db.ref(`${path}/${id}`).update({ status: status }); 
        alert("Status Updated to " + status);
    }

    function deleteMatch(id) { if(confirm("Are you sure you want to delete this match?")) db.ref('matches/'+id).remove(); }

    function updateRoom(id) {
        db.ref('matches/'+id).update({
            roomId: document.getElementById('ri-'+id).value,
            roomPass: document.getElementById('rp-'+id).value
        });
        alert("Room Details Updated!");
    }

    loadDeposits();
    loadWithdrawals();
</script>
</body>
</html>